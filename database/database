SELECT
    CASE 
		WHEN CAST(strftime('%d', G.fecha) AS INTEGER) = T.cierre THEN
			CASE 
				WHEN CAST(strftime('%m', G.fecha) AS INTEGER) = 12 THEN
					date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER)+1, CAST(strftime('%m', G.fecha) AS INTEGER)-11, T.vencimiento))
			ELSE
				date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER), CAST(strftime('%m', G.fecha) AS INTEGER)+1, T.vencimiento))
			END
	ELSE
		CASE 
			WHEN CAST(strftime('%d', G.fecha) AS INTEGER) >= T.cierre+1 THEN
				CASE 
					WHEN CAST(strftime('%m', G.fecha) AS INTEGER) = 12 THEN
						date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER)+1, CAST(strftime('%m', G.fecha) AS INTEGER)-10, T.vencimiento))
				ELSE
					date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER), CAST(strftime('%m', G.fecha) AS INTEGER)+2, T.vencimiento))
				END
		END
	END "FECHA PAGO",
	SUM(G.MONTO) "SUMA DE MONTOS"
FROM GASTOS G
JOIN TARJETAS T ON T.NRO_TARJETA = G.TARJETAS_NRO_TARJETA
JOIN USUARIOS U ON U.USUARIO = G.USUARIOS_USUARIO
JOIN BANCOS B ON B.BANCO = T.BANCOS_BANCO
WHERE U.NOMBRE_USUARIO = 'Mirko' AND B.NOMBRE_BANCO = 'Banco Ripley' AND T.NRO_TARJETA = 2647
GROUP BY "FECHA PAGO"
ORDER BY "FECHA PAGO" DESC;

---- MOSTRAR USUARIOS ----
SELECT 
	USUARIO "ID",
	NOMBRE_USUARIO "USUARIO"
FROM USUARIOS;

---- MOSTRAR BANCOS ----
SELECT 
	BANCO "ID",
	NOMBRE_BANCO "BANCO"
FROM BANCOS;

---- MOSTRAR ESTABLECIMIENTOS ----
SELECT 
	ESTABLECIMIENTO "ID",
	NOMBRE_EST "ESTABLECIMIENTO"
FROM ESTABLECIMIENTOS;

---- MOSTRAR TARJETAS ----
SELECT
	T.NRO_TARJETA "NRO TARJETA",
	B.NOMBRE_BANCO "BANCO",
	T.TIPO "TIPO",
	T.CIERRE "CIERRE",
	T.VENCIMIENTO "VENCIMIENTO",
	U.NOMBRE_USUARIO "USUARIO"
FROM TARJETAS T
JOIN BANCOS B ON T.BANCOS_BANCO = B.BANCO
JOIN USUARIOS U ON T.USUARIOS_USUARIO = U.USUARIO
ORDER BY U.USUARIO;








--PRAGMA foreign_keys = ON;  -- Habilitar restricciones FOREIGN KEY en SQLite
CREATE TABLE usuarios (
    usuario        INTEGER NOT NULL,
    nombre_usuario TEXT NOT NULL,
    PRIMARY KEY (usuario)
);

CREATE TABLE bancos (
    banco        INTEGER NOT NULL,
    nombre_banco TEXT NOT NULL,
    PRIMARY KEY (banco)
);

CREATE TABLE establecimientos (
    establecimiento INTEGER NOT NULL,
    nombre_est      TEXT NOT NULL,
    PRIMARY KEY (establecimiento)
);

CREATE TABLE gastos (
    id                               INTEGER NOT NULL,
    fecha                            TEXT NOT NULL,
    detalle                          TEXT,
    monto                            REAL NOT NULL,
    usuarios_usuario                 INTEGER NOT NULL,
    tarjetas_nro_tarjeta             TEXT NOT NULL,
    establecimientos_establecimiento INTEGER NOT NULL,
    PRIMARY KEY (id),
    FOREIGN KEY (establecimientos_establecimiento) REFERENCES establecimientos(establecimiento) ON DELETE CASCADE,
    FOREIGN KEY (tarjetas_nro_tarjeta) REFERENCES tarjetas(nro_tarjeta) ON DELETE CASCADE,
    FOREIGN KEY (usuarios_usuario) REFERENCES usuarios(usuario) ON DELETE CASCADE
);

CREATE TABLE tarjetas (
    nro_tarjeta      TEXT NOT NULL,
    tipo             TEXT NOT NULL,
    cierre           INTEGER NOT NULL,
    vencimiento      INTEGER NOT NULL,
    usuarios_usuario INTEGER NOT NULL,
    bancos_banco     INTEGER NOT NULL,
    PRIMARY KEY (nro_tarjeta),
    FOREIGN KEY (usuarios_usuario) REFERENCES usuarios(usuario) ON DELETE CASCADE,
    FOREIGN KEY (bancos_banco) REFERENCES bancos(banco) ON DELETE CASCADE
);



INSERT INTO USUARIOS (USUARIO, NOMBRE_USUARIO) VALUES (1, 'Mirko');
INSERT INTO USUARIOS (USUARIO, NOMBRE_USUARIO) VALUES (2, 'Irene');
INSERT INTO USUARIOS (USUARIO, NOMBRE_USUARIO) VALUES (3, 'Isaac');
INSERT INTO USUARIOS (USUARIO, NOMBRE_USUARIO) VALUES (4, 'Felix');
INSERT INTO USUARIOS (USUARIO, NOMBRE_USUARIO) VALUES (5, 'TEST');

INSERT INTO ESTABLECIMIENTOS (ESTABLECIMIENTO, NOMBRE_EST) VALUES (1, 'Tambo');
INSERT INTO ESTABLECIMIENTOS (ESTABLECIMIENTO, NOMBRE_EST) VALUES (2, 'Saga Falabella');
INSERT INTO ESTABLECIMIENTOS (ESTABLECIMIENTO, NOMBRE_EST) VALUES (3, 'Tottus');
INSERT INTO ESTABLECIMIENTOS (ESTABLECIMIENTO, NOMBRE_EST) VALUES (4, 'Plaza Vea');
INSERT INTO ESTABLECIMIENTOS (ESTABLECIMIENTO, NOMBRE_EST) VALUES (5, 'Vivanda');
INSERT INTO ESTABLECIMIENTOS (ESTABLECIMIENTO, NOMBRE_EST) VALUES (6, 'Rokys');

INSERT INTO BANCOS (BANCO, NOMBRE_BANCO) VALUES (1, 'Banco Ripley');
INSERT INTO BANCOS (BANCO, NOMBRE_BANCO) VALUES (2, 'Banco Interbank');
INSERT INTO BANCOS (BANCO, NOMBRE_BANCO) VALUES (3, 'Banco Falabella');
INSERT INTO BANCOS (BANCO, NOMBRE_BANCO) VALUES (4, 'Banco BBVA');
INSERT INTO BANCOS (BANCO, NOMBRE_BANCO) VALUES (5, 'Banco Scotiabank');
INSERT INTO BANCOS (BANCO, NOMBRE_BANCO) VALUES (6, 'Banco de Comercio');
INSERT INTO BANCOS (BANCO, NOMBRE_BANCO) VALUES (7, 'Diners Club');
INSERT INTO BANCOS (BANCO, NOMBRE_BANCO) VALUES (8, 'Financiera OH');

INSERT INTO TARJETAS (NRO_TARJETA, TIPO, CIERRE, VENCIMIENTO, USUARIOS_USUARIO, BANCOS_BANCO) VALUES (2647,'Adicional', 10, 5, 1, 1);
INSERT INTO GASTOS (ID, FECHA, DETALLE, MONTO, USUARIOS_USUARIO, TARJETAS_NRO_TARJETA, ESTABLECIMIENTOS_ESTABLECIMIENTO) VALUES (1, '2023-08-11', 'Empanada de pollo', 2.9, 1, 2647, 1);
INSERT INTO GASTOS (ID, FECHA, DETALLE, MONTO, USUARIOS_USUARIO, TARJETAS_NRO_TARJETA, ESTABLECIMIENTOS_ESTABLECIMIENTO) VALUES (2, '2023-09-11', 'Empanada de carne', 2.9, 1, 2647, 1);
INSERT INTO GASTOS (ID, FECHA, DETALLE, MONTO, USUARIOS_USUARIO, TARJETAS_NRO_TARJETA, ESTABLECIMIENTOS_ESTABLECIMIENTO) VALUES (3, '2023-08-10', 'Empanada de pollo', 2.9, 1, 2647, 1);
INSERT INTO GASTOS (ID, FECHA, DETALLE, MONTO, USUARIOS_USUARIO, TARJETAS_NRO_TARJETA, ESTABLECIMIENTOS_ESTABLECIMIENTO) VALUES (4, '2023-09-10', 'Empanada de carne', 2.9, 1, 2647, 1);




INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('5432', 'Titular', 6, 11, 1, 1);
INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('4123', 'Titular', 10, 20, 2, 2);
INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('5433', 'Adicional', 14, 26, 1, 2);
INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('6576', 'Titular', 7, 20, 2, 3);
INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('8754', 'Adicional', 1, 15, 1, 3);
INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('4345', 'Adicional', 11, 24, 1, 4);
INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('8145', 'Titular', 12, 22, 2, 1);

INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('8253', 'Adicional', 6, 11, 5, 1);
INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('8642', 'Adicional', 10, 20, 5, 2);
INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('8790', 'Adicional', 14, 26, 5, 2);
INSERT INTO TARJETAS(nro_tarjeta, tipo, cierre, vencimiento, usuarios_usuario, bancos_banco) VALUES ('7435', 'Adicional', 7, 20, 5, 3);





SELECT * FROM USUARIOS;
SELECT * FROM BANCOS;
SELECT * FROM TARJETAS;
SELECT * FROM ESTABLECIMIENTOS;
SELECT * FROM GASTOS;

INSERT INTO TARJETAS (NRO_TARJETA, TIPO, CIERRE, VENCIMIENTO, USUARIOS_USUARIO, BANCOS_BANCO) VALUES (2647,'Adicional', 10, 5, 1, 1);

INSERT INTO GASTOS (ID, FECHA, DETALLE, MONTO, USUARIOS_USUARIO, TARJETAS_NRO_TARJETA, ESTABLECIMIENTOS_ESTABLECIMIENTO) VALUES (1, '2023-08-11', 'Empanada de pollo', 2.9, 1, 2647, 1);
INSERT INTO GASTOS (ID, FECHA, DETALLE, MONTO, USUARIOS_USUARIO, TARJETAS_NRO_TARJETA, ESTABLECIMIENTOS_ESTABLECIMIENTO) VALUES (2, '2023-09-11', 'Empanada de carne', 2.9, 1, 2647, 1);
INSERT INTO GASTOS (ID, FECHA, DETALLE, MONTO, USUARIOS_USUARIO, TARJETAS_NRO_TARJETA, ESTABLECIMIENTOS_ESTABLECIMIENTO) VALUES (3, '2023-08-10', 'Empanada de pollo', 2.9, 1, 2647, 1);
INSERT INTO GASTOS (ID, FECHA, DETALLE, MONTO, USUARIOS_USUARIO, TARJETAS_NRO_TARJETA, ESTABLECIMIENTOS_ESTABLECIMIENTO) VALUES (4, '2023-09-10', 'Empanada de carne', 2.9, 1, 2647, 1);


DELETE FROM GASTOS
WHERE tarjetas_nro_tarjeta IN (
    SELECT G.tarjetas_nro_tarjeta
    FROM GASTOS G
    JOIN TARJETAS T ON T.nro_tarjeta = G.tarjetas_nro_tarjeta
    JOIN BANCOS B ON B.BANCO = T.bancos_banco
    WHERE B.banco = 1
);





DELETE FROM USUARIOS;
DELETE FROM BANCOS;
DELETE FROM TARJETAS;
DELETE FROM ESTABLECIMIENTOS;
DELETE FROM GASTOS;






SELECT 
	B.BANCO
	,B.NOMBRE_BANCO
FROM BANCOS B
JOIN TARJETAS T ON T.BANCOS_BANCO = B.BANCO
JOIN USUARIOS U ON U.USUARIO = T.USUARIOS_USUARIO
WHERE U.NOMBRE_USUARIO = 'Irene'
GROUP BY B.BANCO;


SELECT 
	B.BANCO
	,T.NRO_TARJETA
FROM BANCOS B
JOIN TARJETAS T ON T.BANCOS_BANCO = B.BANCO
JOIN USUARIOS U ON U.USUARIO = T.USUARIOS_USUARIO
WHERE U.NOMBRE_USUARIO = 'Irene' AND B.NOMBRE_BANCO = 'Banco Ripley';

UPDATE USUARIOS SET NOMBRE_USUARIO = 'Mirko10'
WHERE USUARIO = 5

UPDATE USUARIOS
SET
	NOMBRE_USUARIO = 'Mirko20'
WHERE USUARIO = 5




SELECT
    T.NRO_TARJETA,
    T.TIPO,
    T.CIERRE,
    T.VENCIMIENTO,
    U.NOMBRE_USUARIO,
    B.NOMBRE_BANCO
FROM TARJETAS T
JOIN USUARIOS U ON U.USUARIO = T.USUARIOS_USUARIO
JOIN BANCOS B ON B.BANCO = T.BANCOS_BANCO;



SELECT * FROM TARJETAS;

UPDATE TARJETAS
SET
	NRO_TARJETA = 1234
WHERE NRO_TARJETA = 2647








SELECT
	T.CIERRE,
	CASE 
		WHEN CAST(strftime('%d', G.fecha) AS INTEGER) <= T.cierre THEN
			CASE 
				WHEN CAST(strftime('%m', G.fecha) AS INTEGER) = 12 THEN
					date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER)+1, CAST(strftime('%m', G.fecha) AS INTEGER)-11, T.vencimiento))
			ELSE
				date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER), CAST(strftime('%m', G.fecha) AS INTEGER)+1, T.vencimiento))
			END
	ELSE
		CASE 
			WHEN CAST(strftime('%d', G.fecha) AS INTEGER) >= T.cierre+1 THEN
				CASE 
					WHEN CAST(strftime('%m', G.fecha) AS INTEGER) = 12 THEN
						date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER)+1, CAST(strftime('%m', G.fecha) AS INTEGER)-10, T.vencimiento))
				ELSE
					date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER), CAST(strftime('%m', G.fecha) AS INTEGER)+2, T.vencimiento))
				END
		END
	END "FECHA PAGO",
	SUM(G.MONTO)
FROM GASTOS G
JOIN TARJETAS T ON T.NRO_TARJETA = G.TARJETAS_NRO_TARJETA
JOIN USUARIOS U ON U.USUARIO = G.USUARIOS_USUARIO
JOIN BANCOS B ON B.BANCO = T.BANCOS_BANCO
WHERE U.NOMBRE_USUARIO = 'Mirko' AND B.NOMBRE_BANCO = 'Banco Ripley' AND T.NRO_TARJETA = 2647
GROUP BY "FECHA PAGO"
ORDER BY "FECHA PAGO" DESC;



SELECT
	G.ID "ID",
	U.NOMBRE_USUARIO "USUARIO",
	G.FECHA "FECHA",
	E.NOMBRE_EST "ESTABLECIMIENTO",
	G.DETALLE "DETALLE",
	B.NOMBRE_BANCO "BANCO",
	T.NRO_TARJETA "NRO TARJETA",
	T.TIPO "TIPO",
	CASE 
		WHEN CAST(strftime('%d', G.fecha) AS INTEGER) <= T.cierre THEN
			CASE 
				WHEN CAST(strftime('%m', G.fecha) AS INTEGER) = 12 THEN
					date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER)+1, CAST(strftime('%m', G.fecha) AS INTEGER)-11, T.vencimiento))
			ELSE
				date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER), CAST(strftime('%m', G.fecha) AS INTEGER)+1, T.vencimiento))
			END
	ELSE
		CASE 
			WHEN CAST(strftime('%d', G.fecha) AS INTEGER) >= T.cierre+1 THEN
				CASE 
					WHEN CAST(strftime('%m', G.fecha) AS INTEGER) = 12 THEN
						date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER)+1, CAST(strftime('%m', G.fecha) AS INTEGER)-10, T.vencimiento))
				ELSE
					date(printf('%04d-%02d-%02d', CAST(strftime('%Y', G.fecha) AS INTEGER), CAST(strftime('%m', G.fecha) AS INTEGER)+2, T.vencimiento))
				END
		END
	END "FECHA PAGO",
	G.MONTO "MONTO"
FROM GASTOS G
JOIN USUARIOS U ON U.USUARIO = G.USUARIOS_USUARIO
JOIN ESTABLECIMIENTOS E ON E.ESTABLECIMIENTO = G.ESTABLECIMIENTOS_ESTABLECIMIENTO
JOIN TARJETAS T ON T.NRO_TARJETA = G.TARJETAS_NRO_TARJETA
JOIN BANCOS B ON B.BANCO = T.BANCOS_BANCO
WHERE U.NOMBRE_USUARIO = 'Mirko' AND B.NOMBRE_BANCO = 'Banco Ripley' AND T.NRO_TARJETA = 2647 AND G.FECHA >= date(printf('%04d-%02d-%02d', 2023, 8, 31)) AND G.FECHA <= date(printf('%04d-%02d-%02d', 2023, 9, 30))
ORDER BY G.FECHA DESC;


SELECT
	CIERRE
FROM TARJETAS
WHERE NRO_TARJETA = 2647;